
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: ingress-gateway-configuration
spec:
  # The selector matches the ingress gateway pod labels.
  # If you installed Istio using Helm following the standard documentation, this would be "istio=ingress"
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*" # domain name of th external website
---
kind: VirtualService
apiVersion: networking.istio.io/v1
metadata:
  name: fleetman-webapp
  namespace: default
spec:
  hosts:
#  - fleetman-webapp.default.svc.cluster.local
  - "*"
  gateways:
    - ingress-gateway-configuration
  http:
    - match:
      - headers: # IF
          x-my-header:
            exact: canary
      # - uri: # IF
      #     prefix: "/experimental"
      # - uri: # OR
      #     prefix: "/canary"
      route: # THEN
      - destination:
          host: fleetman-webapp.default.svc.cluster.local
          subset: experimental
    - route: # CATCH ALL
      - destination:
          host: fleetman-webapp.default.svc.cluster.local
          subset: original
---
kind: DestinationRule
apiVersion: networking.istio.io/v1
metadata:
  name: fleetman-webapp
  namespace: default
spec:
  host: fleetman-webapp.default.svc.cluster.local
  subsets:
  - name: original
    labels:
      version: original
  - name: experimental
    labels:
      version: experimental